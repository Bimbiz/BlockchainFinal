<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeginUp | Gaming Crowdfund</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
      :root {
        --accent: #e94560;
        --bg: #0f3460;
        --card: #16213e;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: white;
        padding: 20px;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      .card {
        background: var(--card);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid #4e4e6a;
      }
      button {
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      input {
        padding: 10px;
        border-radius: 5px;
        border: none;
        margin: 10px 0;
        background: #fff;
        color: #333;
      }
      .donate-box {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
      }
      .eth-input {
        width: 100px;
        font-size: 1.1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>BeginUp Gaming</h1>
      <button id="connect-btn">Connect Wallet</button>

      <div id="user-info" style="display: none; margin-top: 20px">
        <p>
          Wallet: <span id="wallet"></span> | üéÅ Gifts:
          <span id="bal">0</span> BGP
        </p>
        <div class="card" style="margin-top: 10px">
          <label>Your Email:</label>
          <input
            type="email"
            id="email"
            placeholder="example@gmail.com"
            style="width: 100%"
          />
        </div>
      </div>

      <h2>Active Projects</h2>
      <div id="grid">Loading projects...</div>
    </div>

    <script>
      const TOKEN_ADDR = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
      const CROWDFUND_ADDR = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";

      const CF_ABI = [
        "function contribute(uint256 id) public payable",
        "function getAllCampaigns() public view returns (tuple(string title, uint256 goal, uint256 deadline, uint256 totalRaised)[])",
      ];
      const TK_ABI = [
        "function balanceOf(address owner) view returns (uint256)",
      ];

      let provider, signer, account;

      async function init() {
        if (!window.ethereum) return alert("MetaMask not found");
        provider = new ethers.BrowserProvider(window.ethereum);
        loadProjects();
        document.getElementById("connect-btn").onclick = connect;
      }

      async function connect() {
        const accounts = await provider.send("eth_requestAccounts", []);
        account = accounts[0];
        signer = await provider.getSigner();
        document.getElementById("connect-btn").style.display = "none";
        document.getElementById("user-info").style.display = "block";
        document.getElementById("wallet").innerText =
          account.slice(0, 6) + "...";
        updateBal();
      }

      async function updateBal() {
        const contract = new ethers.Contract(TOKEN_ADDR, TK_ABI, provider);
        const b = await contract.balanceOf(account);
        document.getElementById("bal").innerText = ethers.formatEther(b);
      }

      async function loadProjects() {
        const contract = new ethers.Contract(CROWDFUND_ADDR, CF_ABI, provider);
        const list = await contract.getAllCampaigns();
        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        list.forEach((c, i) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
                <h3>${c.title}</h3>
                <p>Goal: ${ethers.formatEther(
                  c.goal,
                )} ETH | Raised: ${ethers.formatEther(c.totalRaised)} ETH</p>
                <div class="donate-box">
                    <input type="number" step="0.01" value="0.1" id="amount-${i}" class="eth-input">
                    <span>ETH</span>
                    <button onclick="donate(${i})">Support!</button>
                </div>
            `;
          grid.appendChild(div);
        });
      }

      async function donate(i) {
        const email = document.getElementById("email").value;
        const amount = document.getElementById(`amount-${i}`).value;

        if (!account || !email)
          return alert("First connect your wallet and enter your email!");
        if (amount <= 0) return alert("Enter an amount greater than 0!");

        try {
          await fetch("http://localhost:3001/register-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address: account, email: email }),
          });

          const contract = new ethers.Contract(CROWDFUND_ADDR, CF_ABI, signer);

          const tx = await contract.contribute(i + 1, {
            value: ethers.parseEther(amount),
          });

          alert("Transaction sent! Awaiting confirmation...");
          await tx.wait();
          alert("Success! Activation code sent to your email.");
          loadProjects();
          updateBal();
        } catch (e) {
          console.error(e);
          alert("Error: " + (e.reason || e.message));
        }
      }
      init();
    </script>
  </body>
</html>
